<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:fn="http://java.sun.com/jsp/jstl/functions"
      xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
      xmlns:rich="http://richfaces.org/rich"
      xmlns:fx="http://www.flexive.com/jsf/core"
      xmlns:adm="http://www.flexive.com/jsf/admin"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:jstl="http://java.sun.com/jsp/jstl/functions">

<ui:composition>
       <c:if test="#{empty srcEditor.parseRequestParameters}"> </c:if>
            <t:inputHidden id="editorType" value="#{srcEditor.editorType}" />

            <!-- Content select screen -->
            <ui:fragment rendered="#{srcEditor.initialized==false}">
                <adm:tab label="#{fxMessageBean['Content.tabtitle.chooseType']}" active="true" id="tabChoose"/>
                <t:selectOneListbox size="1" id="type" value="#{srcEditor.type}">
                    <f:selectItems value="#{srcEditor.editableTypes}" />
                </t:selectOneListbox>
                <br/><br/>
                <adm:commandButton labelKey="Content.button.create" location="both"
                                  bean="#{srcEditor}"
                                  icon="save" action="initNew" id="initButton"/>
            </ui:fragment>


            <!-- Content editor screen -->
            <ui:fragment rendered="#{srcEditor.initialized}">
                <c:set var="currentId" value="${srcEditor.id}"/>
                <ui:fragment rendered="#{srcEditor.new}">
                    <adm:tab label="#{fxMessageBean['Content.tabtitle.new']}" active="true" id="tabEditNew"/>
                </ui:fragment>
                <ui:repeat var="srcEditor" value="#{srcEditor}">
                    <ui:fragment rendered="#{!srcEditor.new}">
                        <ui:fragment rendered="#{srcEditor.readOnly}">
                            <adm:tab label="#{fxMessageBean['Content.tabtitle.readonly,#{srcEditor.id},#{srcEditor.version}']}"
                                    active="true" id="tabEditInit1"/>
                        </ui:fragment>
                        <ui:fragment rendered="#{!srcEditor.readOnly}">
                            <adm:tab label="#{fxMessageBean['Content.tabtitle.edit,#{srcEditor.id},#{srcEditor.version}']}"
                                    active="true" id="tabEditInit2"/>
                        </ui:fragment>
                    </ui:fragment>
                </ui:repeat>


                <ui:fragment rendered="#{!srcEditor.new}">
                <a4j:outputPanel id="infoPanel">
                    <a4j:commandLink reRender="infoPanel">
                        <f:setPropertyActionListener value="#{srcEditor.infoPanelState=='version'?'':'version'}" target="#{srcEditor.infoPanelState}"/>
                        <span class="infoPanelButton">#{fxMessageBean['Content.field.info']}</span>
                    </a4j:commandLink>&nbsp;
                    <a4j:commandLink reRender="infoPanel" rendered="#{srcEditor.versionInfo.versionCount > 1}">
                        <f:setPropertyActionListener value="#{srcEditor.infoPanelState=='compare'?'':'compare'}" target="#{srcEditor.infoPanelState}"/>
                        <span class="infoPanelButton">#{fxMessageBean['Content.field.versionCompare']}</span>
                    </a4j:commandLink>
                    <a4j:commandLink reRender="infoPanel" rendered="#{fxMapBean.types[srcEditor.type].trackHistory}">
                        <f:setPropertyActionListener value="#{srcEditor.infoPanelState=='history'?'':'history'}" target="#{srcEditor.infoPanelState}"/>
                        <span class="infoPanelButton">#{fxMessageBean['Content.field.history']}</span>
                    </a4j:commandLink>
                    <a4j:commandLink reRender="infoPanel" rendered="#{srcEditor.mayExport}">
                        <f:setPropertyActionListener value="#{srcEditor.infoPanelState=='export'?'':'export'}" target="#{srcEditor.infoPanelState}"/>
                        <span class="infoPanelButton">#{fxMessageBean['Content.field.export']}</span>
                    </a4j:commandLink>
                    <ui:fragment rendered="#{srcEditor.infoPanelState=='export'}">
                        <span class="infoPanel">
                            <span class="infoPanelButton" style="margin: 12px; display: block; float: left;" onclick="copy2clipboard(getPreElementContent('exportArea'),'#{fxMessageBean['Global.clipboard.error']}','#{fxMessageBean['Global.clipboard.success']}')">#{fxMessageBean['Content.button.copyToClipboard']}</span>
                            <br clear="both"/>
                            <pre id="exportArea">#{srcEditor.exportData}</pre>
                        </span>
                    </ui:fragment>
                    <ui:fragment rendered="#{srcEditor.infoPanelState=='version'}">
                        <span class="infoPanel"><adm:ceVersionInfo versionInfo="#{srcEditor.versionInfo}"/></span>
                    </ui:fragment>
                    <ui:fragment rendered="#{srcEditor.infoPanelState=='history'}">
                        <span class="infoPanel">
                            #{fxMessageBean['Content.label.history.info']}
                            <table class="historyTable">
                                <tr>
                                    <th>#{fxMessageBean['Content.field.history.dateTime']}</th>
                                    <th>#{fxMessageBean['Content.field.history.version']}</th>
                                    <th>#{fxMessageBean['Content.field.history.account']}</th>
                                    <th>#{fxMessageBean['Content.field.history.host']}</th>
                                    <th>#{fxMessageBean['Content.field.history.application']}</th>
                                </tr>
                                <tr>
                                    <th>&nbsp;</th>
                                    <th class="action" colspan="4">#{fxMessageBean['Content.field.history.action']}</th>
                                </tr>
                            <ui:repeat var="entry" value="#{srcEditor.historyEntries}">
                                <tr>
                                    <td nowrap="nowrap">
                                        #{fxMapBean.dateTime[entry.timestp]}
                                    </td>
                                    <td>
                                        #{entry.contentVersion}
                                    </td>
                                    <td>
                                        #{entry.loginName}
                                    </td>
                                    <td>
                                        #{entry.host}
                                    </td>
                                    <td>
                                        #{entry.application}
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td class="action" colspan="4">#{entry.message}</td>
                                </tr>
                            </ui:repeat>

                            </table>
                        </span>
                    </ui:fragment>
                    <ui:fragment rendered="#{srcEditor.infoPanelState=='compare'}">
                        <span class="infoPanel">
                            <table>
                                <tr>
                                    <td>
                                        #{fxMessageBean['Content.field.compare.source']}
                                    </td>
                                    <td>
                                        <h:selectOneListbox id="srcComp" value="#{srcEditor.compareSourceVersion}"
                                                            size="1" required="true">
                                        <f:selectItems value="#{srcEditor.compareVersions}"/>
                                        </h:selectOneListbox>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        #{fxMessageBean['Content.field.compare.destination']}
                                    </td>
                                    <td>
                                        <h:selectOneListbox id="dstComp" value="#{srcEditor.compareDestinationVersion}"
                                                            size="1"
                                                            required="true">
                                            <f:selectItems value="#{srcEditor.compareVersions}"/>
                                        </h:selectOneListbox>
                                    </td>
                                </tr>
                            </table>

                            <a4j:commandLink reRender="comparePanel, infoPanel" rendered="#{srcEditor.versionInfo.versionCount > 1}">
                                <span class="infoPanelButton">#{fxMessageBean['Content.button.compare']}</span>
                            </a4j:commandLink><br/><br/>
                            <a4j:outputPanel id="comparePanel" rendered="#{srcEditor.compareSourceVersion > 0 and srcEditor.compareDestinationVersion > 0}">
                                <c:set var="compEntries" value="#{srcEditor.compareEntries}"/>
                                #{fxMessageBean['Content.field.compare.changeCount']} #{fn:length(compEntries)}
                                <ui:fragment rendered="#{fn:length(compEntries) > 0}">
                                <table class="changesTable">
                                    <tr>
                                        <th><!-- empty --></th>
                                        <th>#{fxMessageBean['Content.field.compare.xpath']}</th>
                                        <th>#{fxMessageBean['Content.field.compare.source.changes']}</th>
                                        <th>#{fxMessageBean['Content.field.compare.destination.changes']}</th>
                                    </tr>
                                    <ui:repeat var="change" value="#{compEntries}">
                                        <ui:fragment>
                                            <tr>
                                                <td class="changeInfo">
                                                    <ui:fragment
                                                            rendered="#{change.positionChange and change.changeType == 'Update'}">
                                                        <t:graphicImage
                                                                title="Position #{change.originalData.pos} -> #{change.newData.pos}"
                                                                alt="position changed"
                                                                url="/adm/images/contentEditor/change_position.png"/>
                                                    </ui:fragment>
                                                </td>
                                                <td class="changeLeft change#{change.changeType}">#{change.XPath}</td>
                                                <td class="changeMiddle change#{change.changeType}">
                                                    <ui:fragment
                                                            rendered="#{(change.changeType == 'Update' and change.dataChange) or change.changeType == 'Remove'}">
                                                        <div class="changeData">
                                                            <fx:fxValueInput value="#{change.originalData.value}"
                                                                             readOnly="true"/>
                                                        </div>
                                                    </ui:fragment>
                                                </td>
                                                <td class="changeRight change#{change.changeType}">
                                                    <ui:fragment
                                                            rendered="#{(change.changeType == 'Update' and change.dataChange) or change.changeType == 'Add'}">
                                                        <div class="changeData">
                                                            <fx:fxValueInput value="#{change.newData.value}"
                                                                             readOnly="true"/>
                                                        </div>
                                                    </ui:fragment>
                                                </td>
                                            </tr>
                                        </ui:fragment>
                                    </ui:repeat>
                                </table>
                                </ui:fragment>
                            </a4j:outputPanel>
                        </span>
                    </ui:fragment>
                </a4j:outputPanel>
                </ui:fragment>

                    <a4j:outputPanel id="all">

                        <script type="text/javascript">
                            <!--

                            function startUpload(id) {
                                var _iframe = window.frames['fileupload'+id].document;
                                if (_iframe.getElementById('theFile').value=='') {
                                    alert('Please select a file first');
                                } else {
                                    parent.lockScreen();
                                    _iframe.getElementById('myForm').submit();
                                    document.getElementById("uploadInfo"+id).innerHTML='uploading...';
                                }
                            }

                            function uploadFinished() {
                                document.getElementById("frm:storeButton").onclick();
                            }

                            // to identify the content editor from other frames
                            var isContentEditor = true;
                            var isReadOnly = #{srcEditor.readOnly};
                            var form = document.forms["frm"];

                            function addTreeNode(nodeId) {
                                form["frm:treeNodeParent"].value = nodeId;
                                document.getElementById("frm:addTreeNodeButton").onclick();
                            }
                            //-->
                        </script>


                        <!-- General fields -->
                        <table>
                            <!-- FxType -->
                            <tr>
                                <td colspan="2">
                                    #{srcEditor.typeDisplay}
                                </td>
                            </tr>
                            <!-- PREVIEW -->
                            <tr>
                                <td colspan="2">
                                    <ui:fragment rendered="#{srcEditor.content.previewAvailable}">
                                        <img src="thumbnail/pk#{srcEditor.id}.1/s2/ts#{fxSystemBean.currentTimeMillis}"
                                             alt="Preview" title="Preview" border="0" style="border:1px solid gray"/>
                                    </ui:fragment>
                                </td>
                            </tr>
                            <!-- ACL -->
                            <tr>
                                <ui:fragment rendered="#{not srcEditor.supportSecurity}">
                                    <td colspan="2"><i>#{fxMessageBean['Content.msg.noSecurity']}</i></td>
                                </ui:fragment>
                                <ui:fragment rendered="#{srcEditor.supportSecurity}">
                                    <td>
                                        #{fxMessageBean['Content.field.ACL']}
                                    </td>
                                    <td>
                                        <ui:fragment rendered="#{srcEditor.readOnly==false}">
                                            <t:selectOneListbox size="1" id="acl" value="#{srcEditor.acl}"
                                                                converter="SelectableConverter">
                                                <f:selectItems value="#{fxSelectBean.contentACLs}"/>
                                            </t:selectOneListbox>
                                        </ui:fragment>
                                        <ui:fragment rendered="#{srcEditor.readOnly==true}">
                                            <span class="readonlyValue">#{srcEditor.acl.name}</span>
                                        </ui:fragment>
                                    </td>
                                </ui:fragment>
                            </tr>
                            <!-- Workflow step -->
                            <tr>
                                <td>
                                    #{fxMessageBean['Content.field.step']}
                                </td>
                                <td>
                                    <ui:fragment rendered="#{srcEditor.readOnly==false}">
                                        <t:selectOneListbox size="1" id="step" value="#{srcEditor.step}">
                                            <f:selectItems value="#{srcEditor.possibleWorkflowSteps}"/>
                                        </t:selectOneListbox>
                                    </ui:fragment>
                                    <ui:fragment rendered="#{srcEditor.readOnly==true}">
                                        <span class="readonlyValue">#{srcEditor.stepDescription}</span>
                                    </ui:fragment>
                                </td>
                            </tr>
                            <!-- Tree nodes -->
                            <tr>
                                <td valign="top">
                                    #{fxMessageBean['Content.field.nodes']}
                                </td>
                                <td>
                                    <!-- Tree -->
                                    <adm:ceRenderTreeNodes srcEditor="#{srcEditor}"/>
                                </td>
                            </tr>
                        </table>

                        <!-- binary support hack -->
                        <t:inputHidden value="#{srcEditor.editorActionName}"  id="editorActionName"/>
                        <t:inputHidden value="#{srcEditor.editorActionXpath}" id="editorActionXpath"/>

                        <!-- Properties and Groups -->
                        <t:inputHidden value="#{srcEditor.elements}" id="elements"/>
                        <div style="position:relative;left:-10px">
                            <div style="padding-top: 3px; padding-left: 8px; width: 30px; float: left;">
                                <adm:ceRenderFieldMenu group="#{srcEditor.content.rootGroup}" icon="group"
                                                       srcEditor="#{srcEditor}"/>
                            </div>
                            <br clear="both"/>
                            <adm:ceRenderFields data="#{srcEditor.content.rootGroup.children}" srcEditor="#{srcEditor}"/>
                        </div>
                        <ui:repeat value="#{fxSystemBean.groupedFxMessages}" var="msg">
                            <ui:repeat value="#{msg.messages}" var="item">
                                    <script type="text/javascript">
                                        parent.addClientIdWithError(this, '#{item.clientId}', '#{item.detailForJavascript}');
                                    </script>
                            </ui:repeat>
                        </ui:repeat>
                        <script type="text/javascript">
                            parent.renderErrors();
                        </script>
                    </a4j:outputPanel>

                <div style="clear:both;height:20px"><!-- __ --></div>

                <ui:fragment rendered="#{srcEditor.readOnly and srcEditor.editAble}">
                    <adm:commandButton labelKey="Content.button.edit" location="both"
                                      bean="#{srcEditor}"
                                      icon="edit" action="enableEdit" id="enableEditButton"/>
                    <ui:fragment rendered="#{srcEditor.deleteAble}">
                        <adm:commandButton labelKey="Content.button.delete" location="both"
                                           bean="#{srcEditor}" confirmKey="Content.confirm.delete"
                                           icon="delete" action="delete" id="deleteButtonRO"/>
                    </ui:fragment>
                    <ui:fragment rendered="#{srcEditor.versionDeleteAble}">
                        <adm:commandButton labelKey="Content.button.deleteVersion" location="both"
                                           bean="#{srcEditor}" confirmKey="Content.confirm.deleteVersion"
                                           icon="deleteVersion" action="deleteCurrentVersion" id="deleteVersionButtonRO"/>
                    </ui:fragment>
                </ui:fragment>
                <ui:fragment rendered="#{srcEditor.readOnly==false}">
                    <!--
                    <adm:commandButton label="Content.button.saveInSession" location="both"
                                      bean="#{srcEditor}"
                                      icon="saveInSession" action="saveInSession" id="storeButton"/>
                                      -->

                    <ui:fragment rendered="#{srcEditor.new}">
                        <adm:commandButton labelKey="Content.button.create" location="both"
                                          bean="#{srcEditor}"
                                          icon="new" action="save" id="createButton" onclick="preSubmit()"/>
                    </ui:fragment>

                    <ui:fragment rendered="#{srcEditor.new==false}">
                        <adm:commandButton labelKey="Content.button.save" location="both"
                                          bean="#{srcEditor}"
                                          icon="save" action="save" id="saveButton" onclick="preSubmit()"/>

                        <adm:commandButton labelKey="Content.button.saveInNewVersion" location="both"
                                          bean="#{srcEditor}"
                                          icon="newVersion" action="saveInNewVersion" id="saveInNewVersionButton"
                                          onclick="preSubmit()"/>

                        <adm:commandButton labelKey="Content.button.refresh" location="both"
                                          bean="#{srcEditor}" confirmKey="Content.confirm.refresh"
                                          icon="reload" action="reload" id="reloadButton" onclick="preSubmit()"/>

                        <ui:fragment rendered="#{srcEditor.deleteAble}">
                            <adm:commandButton labelKey="Content.button.delete" location="both"
                                          bean="#{srcEditor}" confirmKey="Content.confirm.delete"
                                          icon="delete" action="delete" id="deleteButton" onclick="preSubmit()"/>
                        </ui:fragment>
                        <ui:fragment rendered="#{srcEditor.versionDeleteAble}">
                            <adm:commandButton labelKey="Content.button.deleteVersion" location="both"
                                          bean="#{srcEditor}" confirmKey="Content.confirm.deleteVersion"
                                          icon="deleteVersion" action="deleteCurrentVersion" id="deleteVersionButton"
                                          onclick="preSubmit()"/>
                        </ui:fragment>
                    </ui:fragment>


                    <adm:commandButton labelKey="Content.button.compact" location="toolbar"
                                      bean="#{srcEditor}" separator="before"
                                      icon="compact" action="compact" id="compactButton" onclick="preSubmit()"/>

                    <adm:commandButton labelKey="Content.button.cancel" location="both"
                                      bean="#{srcEditor}" confirmKey="Content.confirm.abort"
                                      icon="cancel" action="cancel" id="cancelButton" onclick="preSubmit()"/>
                </ui:fragment>
            </ui:fragment>
</ui:composition>


</html>
