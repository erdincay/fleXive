<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:a4j="https://ajax4jsf.dev.java.net/ajax"
      xmlns:adm="http://www.flexive.com/jsf/admin"
      xmlns:fx="http://www.flexive.com/jsf/core"
      xmlns:weblet="http://weblets.dev.java.net/tags_jsp2">
<body>

<ui:composition template="/adm/contentTemplate.xhtml">
    <ui:define name="head">
        <script type="text/javascript" src="#{fxSystemBean.contextPath}/pub/js/#{adm:versionedUrl('selection.js')}"> </script>
        <script type="text/javascript" src="#{weblet:url('com.flexive.faces.weblets','/js/lytebox.js')}"></script>
    </ui:define>

    <ui:define name="body">
        <c:if test="#{empty fxSearchResultBean.parseRequestParameters}"> </c:if>
        <a4j:form id="frm">
            <h:inputHidden value="#{fxSearchResultBean.viewType}"/>

            <adm:resultTabs activeTab="results"/>

            <script type="text/javascript">
            <!--
                function onShowContextMenu() {
                    try {
                        var perms = flexive.yui.datatable.getPermissions(resultTable, this.contextEventTarget);
                        var selectedIds = getSelectedIds();
                        var briefcaseId = getBriefcaseId();
                        flexive.yui.setMenuItem("deleteSelected", "disabled", selectedIds.length == 0 || !perms["delete"]);
                        flexive.yui.setMenuItem("copy", "disabled", selectedIds.length == 0);
                        flexive.yui.setMenuItem("deleteBriefcaseSelected", "disabled", briefcaseId == -1 || selectedIds.length == 0);
                        flexive.yui.setMenuItem("deleteBriefcase", "disabled", briefcaseId == -1);
                        flexive.yui.setMenuItem("edit", "disabled", !perms.edit);
                        flexive.yui.setMenuItem("delete", "disabled", !perms["delete"]);
                    } catch (e) {
                        alertDialog(e);
                    }
                }

                function getSelectedIds() {
                    return flexive.util.getPkIds(flexive.yui.datatable.getSelectedPks(resultTable));
                }

                function getBriefcaseId() {
                    return #{empty fxSearchResultBean.briefcase ? -1 : fxSearchResultBean.briefcase.id};
                }

                function onContextMenu(type, args) {
                    // extract PK
                    var pk = flexive.yui.datatable.getPk(resultTable, this.contextEventTarget);
                    storePk(pk);

                    var selectedIds = getSelectedIds();
                    var briefcaseId = getBriefcaseId();
                    var menuItem = args[1];
                    if (menuItem.cfg.getProperty("disabled")) {
                        return;
                    }
                    switch (menuItem.id) {
                        case "show":
                            openContent(pk);
                            break;
                        case "edit":
                            editContent(pk);
                            break;
                        case "showScreenview":
                            var a = document.createElement("a");
                            a.href = getBase()+"thumbnail/pk" + pk.id + "." + pk.version + "/so";
                            a.rel = "lytebox";
                            a.title = "Screenview " + pk.id + "." + pk.version;
                            myLytebox.start(a, false, false);
                            break;
                        case "copy":
                            parent.getContentClipboard().set(selectedIds);
                            break;
                        case "delete":
                            deleteContent(pk);
                            break;
                        case "deleteSelected":
                            confirmDialog("#{fxMessageBean['SearchResult.dialog.confirm.deleteSelection']}", function() {
                                try {
                                    flexive.util.getJsonRpc().ContentEditor.removeMultiple(selectedIds);
                                    reload();
                                } catch (e) {
                                    alertDialog(e);
                                }
                            });
                            break;
                        case "deleteBriefcase":
                            deleteFromBriefcase(pk);
                            break;
                        case "deleteBriefcaseSelected":
                            try {
                                flexive.util.getJsonRpc().BriefcaseEditor.removeItems(briefcaseId, selectedIds);
                                reload();
                            } catch (e) {
                                alertDialog(e);
                            }
                            break;
                        default:
                    }
                }

                function reload() {
                    parent.lockScreen();
                    document.forms["frm"].submit();
                }

                function storePk(/* PK */ pk) {
                    document.getElementById("frm:contentEditorId").value = pk.id;
                    document.getElementById("frm:contentEditorVersion").value = pk.version;
                }

                function openContent(/* PK */ pk) {
                    storePk(pk);
                    document.getElementById("frm:showButton").onclick();
                }

                function editContent(/* PK */ pk) {
                    storePk(pk);
                    document.getElementById("frm:editButton").onclick();
                }

                function deleteContent(/* PK */ pk) {
                    confirmDialog("#{fxMessageBean['SearchResult.dialog.confirm.deleteRow']}", function() {
                        try {
                            flexive.util.getJsonRpc().ContentEditor.remove(pk.id);
                            reload();
                        } catch (e) {
                            alertDialog(e);
                        }
                    });
                }

                function deleteFromBriefcase(/* PK */ pk) {
                    try {
                        flexive.util.getJsonRpc().BriefcaseEditor.removeItems(getBriefcaseId(), [pk.id]);
                        reload();
                    } catch (e) {
                        alertDialog(e);
                    }
                }

                function openContextMenuAt(el) {
                    var xy = YAHOO.util.Dom.getXY(el);
                    resultsMenu.moveTo(xy[0], xy[1]);
                    resultsMenu.contextEventTarget = el;
                    resultsMenu.triggerContextMenuEvent.fire();
                    resultsMenu.show();
                }

                /** Add action links in list mode */
                var _actionColumnHandler = new flexive.yui.datatable.ActionColumnHandler();
                _actionColumnHandler.getActionColumn = function(pk, permissions) {
                    if (pk == null) {
                        return "";
                    }
                    var out = [];
                    var pkArg = "flexive.util.parsePk(\"" + pk.toString() + "\")";
                    if (permissions == null || permissions["edit"]) {
                        out.push("<a href='javascript:editContent(" + pkArg + ");'>#{fxMessageBean['SearchResult.button.action.edit']}</a>");
                    } else if (permissions == null || permissions["read"]) {
                        out.push("<a href='javascript:openContent(" + pkArg + ");'>#{fxMessageBean['SearchResult.button.action.open']}</a>");
                    }
                    if (permissions == null || permissions["delete"]) {
                        out.push("<a href='javascript:deleteContent(" + pkArg + ");'>#{fxMessageBean['SearchResult.button.action.delete']}</a>");
                    }
                    if (getBriefcaseId() != -1) {
                        // remove from briefcase
                        out.push("<a href='javascript:deleteFromBriefcase(" + pkArg + ");'>#{fxMessageBean['SearchResult.button.action.deleteFromBriefcase']}</a>");
                    }
                    var id = "more_link_" + pk.toString();
                    out.push("<a id='" + id + "' href='javascript:openContextMenuAt(\"" + id + "\")'>#{fxMessageBean['SearchResult.button.action.more']}</a>");
                    return out.join(" | ");
                }
            //-->
            </script>

            <c:if test="#{fxSearchResultBean.queryBuilder != null}">
                <!-- Eager fetching of result: #{fxSearchResultBean.result} -->
                <h:inputHidden id="fetchRows" value="#{fxSearchResultBean.fetchRows}"/>
                <h:inputHidden id="versionFilter" value="#{fxSearchResultBean.versionFilter}"/>
                <h:inputHidden id="sortColumnKey" value="#{fxSearchResultBean.sortColumnKey}"/>
                <h:inputHidden id="sortDirection" value="#{fxSearchResultBean.sortDirection}"/>
                <h:inputHidden id="paginatorPage" value="#{fxSearchResultBean.paginatorPage}"/>
                <h:inputHidden id="contentEditorId" value="#{contentEditorBean.id}"/>
                <h:inputHidden id="contentEditorVersion" value="#{contentEditorBean.version}"/>

                <h:selectOneListbox id="typeId" value="#{fxSearchResultBean.typeId}" size="1">
                    <f:selectItems value="#{fxSearchResultBean.contentTypeItems}"/>
                    <a4j:support event="onchange" actionListener="#{fxSearchResultBean.resetTableView}" reRender="refreshResults"/>
                </h:selectOneListbox>
                <h:selectOneListbox id="version" value="#{fxSearchResultBean.versionFilter}" size="1">
                    <f:selectItems value="#{fxSearchResultBean.versionItems}"/>
                    <a4j:support event="onchange" actionListener="#{fxSearchResultBean.resetTableView}" reRender="refreshResults"/>
                </h:selectOneListbox>

                <a4j:outputPanel id="refreshResults">
                    <fx:resultTableUpdater var="resultTable" value="#{fxSearchResultBean.result}"/>
                </a4j:outputPanel>


                <div id="resultTableContainer">
                    <fx:resultTable var="resultTable" value="#{fxSearchResultBean.result}" actionColumnHandler="_actionColumnHandler"/>
                </div>

                <fx:menu name="resultsMenu" beforeShow="onShowContextMenu" clickHandler="onContextMenu" trigger="'resultTableContainer'">
                    <fx:menuItem id="show" labelKey="SearchResult.menu.show" icon="open"/>
                    <fx:menuItem id="showScreenview" labelKey="SearchResult.menu.showScreenview" icon="open"/>
                    <fx:menuItem id="edit" labelKey="SearchResult.menu.edit" icon="edit"/>
                    <!--<fx:menuSeparator/>-->
                    <fx:menuItem id="copy" labelKey="SearchResult.menu.copy" icon="copy"/>
                    <!--<fx:menuSeparator/>-->
                    <fx:menuItem id="deleteBriefcase" labelKey="SearchResult.menu.deleteBriefcase" icon="removeBriefcaseItems"/>
                    <fx:menuItem id="deleteBriefcaseSelected" labelKey="SearchResult.menu.deleteBriefcaseSelected" icon="removeBriefcaseItems"/>
                    <fx:menuItem id="delete" labelKey="SearchResult.menu.delete" icon="remove"/>
                    <fx:menuItem id="deleteSelected" labelKey="SearchResult.menu.deleteSelected" icon="remove"/>
                </fx:menu>

                <div style="display:none">
                    <h:commandLink id="showButton" action="#{contentEditorBean.load}" onclick="parent.lockScreen()">
                        <f:setPropertyActionListener value="#{true}" target="#{contentEditorBean.readOnly}"/>
                    </h:commandLink>
                    <h:commandLink id="editButton" action="#{contentEditorBean.load}" onclick="parent.lockScreen()">
                        <f:setPropertyActionListener value="#{false}" target="#{contentEditorBean.readOnly}"/>
                    </h:commandLink>
                </div>
            </c:if>

            <br/>
            <adm:commandButton id="listButton" labelKey="SearchResult.button.view.list"
                               bean="#{fxSearchResultBean}" action="listView"
                               icon="view_list" location="both"
                               rendered="#{fxSearchResultBean.viewType != 'LIST'}"/>
            <adm:commandButton id="thumbsButton" labelKey="SearchResult.button.view.thumbs"
                               bean="#{fxSearchResultBean}" action="thumbView"
                               icon="view_thumbs" location="both"
                               rendered="#{fxSearchResultBean.viewType != 'THUMBNAILS'}"/>
            <adm:commandButton id="preferencesButton" labelKey="ResultPreferences.button.open" bean="#{resultPreferencesBean}" action="show" icon="configure" location="both">
                <f:setPropertyActionListener value="#{fxSearchResultBean.typeId}" target="#{resultPreferencesBean.type}"/>
                <f:setPropertyActionListener value="#{fxSearchResultBean.viewType}" target="#{resultPreferencesBean.viewType}"/>
            </adm:commandButton>

            <adm:toolbarPluginButtons/>

        </a4j:form>

        <script type="text/javascript">
        <!--
            if (parent.reloadBriefcases) {
                parent.reloadBriefcases();
            }
            
            flexive.yui.onYahooLoaded(function() {
                // store sort information in form variables
                resultTable.subscribe("columnSortEvent", function(args) {
                    document.getElementById("frm:sortColumnKey").value = args.column.key;
                    document.getElementById("frm:sortDirection").value = args.dir;
                });
                // subscribe to paginator changes
                var paginator = resultTable.get("paginator");
                paginator.subscribe("pageChange", function(event) {
                    document.getElementById("frm:paginatorPage").value = event.newValue;
                });
                paginator.subscribe("rowsPerPageChange", function(event) {
                    document.getElementById("frm:fetchRows").value = event.newValue;
                });

                // fetch old sort information, apply it if the column still exists
                var sortColumnKey = "#{fxSearchResultBean.sortColumnKey}";
                if (sortColumnKey != "null" && sortColumnKey.length > 0) {
                    var col = resultTable.getColumn(sortColumnKey);
                    if (col != null) {
                        resultTable.sortColumn(col, "#{fxSearchResultBean.sortDirection}");
                    } else {
                        // reset sort information
                        document.getElementById("frm:sortColumnKey").value = "";
                    }
                }

                // fetch old page/rows per page settings
                var page = #{fxSearchResultBean.paginatorPage};
                var rowsPerPage = #{fxSearchResultBean.fetchRows};
                if (rowsPerPage > 0) {
                    paginator.setRowsPerPage(rowsPerPage, false);
                }
                if (page > 0) {
                    paginator.setPage(page, false);
                }
            });
        //-->
        </script>
    </ui:define>

</ui:composition>

</body>
</html>
