<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:c="http://java.sun.com/jstl/core"
      xmlns:fn="http://java.sun.com/jsp/jstl/functions"
      xmlns:t="http://myfaces.apache.org/tomahawk"
      xmlns:adm="http://www.flexive.com/jsf/admin"
      xmlns:fx="http://www.flexive.com/jsf/core">

<ui:composition template="/adm/templates/navigation.xhtml">

    <ui:define name="content">

        <!-- Render tree node styles for types with icons -->
        <style type="text/css">
            <ui:repeat var="type" value="#{fxSystemBean.environment.types}">
                <ui:fragment rendered="#{not type.icon.isEmpty}">
                    .TreeIconType_#{type.id} {
                        background-image: url('<fx:thumbnail pk="#{type.icon.defaultTranslation}" urlOnly="true" previewSize="original" width="16" height="16"/>');
                    }
                </ui:fragment>
            </ui:repeat>
        </style>
		<script type="text/javascript">
		<!--
            //var contentPage=null;     tracks which page is shown in the content frame..no longer used

            var copyNode=null;
            //copyMode->copy was selected in context menu
            var copyMode=false;
            //cutMode->cut was selected in context menu
            var cutMode=false;
            //flag indicating if the content tree nav frame needs reloading
            //at the moment this is the case when a type has been created or deleted
            var reloadContentTreeNavFrame=false;

                //actions defined in StructureTreeControllerBean
            function doTreeAction(action, id, value) {
                if (action =="RENAME_ASSIGNMENT") {
                    setTitle(id,value, false);
                }
                if (action =="RENAME_TYPE") {
                    setTitle(id,value, true);
                }
                if (action =="RENAME_SELECT_TYPE") {
                    setTitle(id,value, true);
                    selectNode(id, true);
                }
                if (action =="RENAME_SELECT_ASSIGNMENT") {
                    setTitle(id,value, false);
                    selectNode(id, false);
                }
                if (action=="RELOAD_SELECT_TYPE") {
                    reloadAndKeepExpanded();
                    structureTreeClickHandler(selectNode(id, true));
                }
                if (action=="RELOAD_SELECT_ASSIGNMENT") {
                    reloadAndKeepExpanded();
                    selectNode(id, false);
                }
                if (action=="RELOAD_EXPAND_TYPE") {
                    reloadStructureTree();
                }
                if (action=="RELOAD_EXPAND_ASSIGNMENT") {
                    reloadStructureTree();
                    expandToNodeWithId(id, false);
                }
            }

            /* expands the tree and selects the node with ID id
                returns the node object
                isType controls if the node is an assignment or type
                true for type, false for assignment
             */
             function selectNode(id, isType) {
                var node = expandToNodeWithId(id, isType);
                getFxSelector().deselectAll();
                getFxSelector().select(node);
                return node;
            }

            /* expands the tree, selects node and performs click operation
             */
            function openNode(id, isType) {
                structureTreeClickHandler(selectNode(id,isType));
            }

            /*
                isType controls if the node is an assignment or type
                true for type, false for assignment
            */
            function setTitle(id, title, isType) {
                var node= expandToNodeWithId(id, isType);
                if (node.title != title)
                    node.setTitle(title);
            }

            function reloadStructureTree() {
                var newChildren = eval("(" + flexive.util.getJsonRpc().StructureTreeWriter.renderStructureTree(-1) + ")");
                dojo.widget.byId('structureTree').setChildren(newChildren);
                //contentPage=null;
            }
                
            function getFxSelector() {
                return dojo.widget.byId('structureTree').fxSelector;
            }

            function getFxController() {
                return dojo.widget.byId('structureTree').fxController;
            }

            /*expands all parents up to the node with ID id
            the node objects are lazily initialized, altough they are searchable via the propertyId,
            the actual node object is initialized when the parent node is expanded, so it is necessarry to
            obtain the possibly uninitialized children anew after the parent was expanded
            isType controls if the node is an assignment or type
            true for type, false for assignment
            return the initialized node object with the ID id
            */
            function expandToNodeWithId(id, isType) {
                var nodePath =getNodePath(id, isType);
                var childNodeToExpand=dojo.widget.byId('structureTree');
                for (var i=0;i<nodePath.length-1;i++) {
                    var childIndex=nodePath[i][1];
                    childNodeToExpand=childNodeToExpand.children[childIndex];
                    getFxController().expandToNode(childNodeToExpand,true);
                }
                return childNodeToExpand.children[nodePath[nodePath.length-1][1]];
             }

            function arraycopy(source) {
                dest = new Array(source.length);
                for (var i=0;i<source.length;i++) {
                    dest[i]=source[i];
                }
                return dest;
            }

           /*Returns a 2dim array of nodes which are currently expanded, first array entry is id,
            *second is node doc type.
            *
            */
            function getExpandedNodes() {
                return _buildExpandedArray(dojo.widget.byId('structureTree').children, new Array());
            }

            function _buildExpandedArray(childArray, expandedArray) {
                var harray=arraycopy(expandedArray);
                for (var i=0;i<childArray.length;i++) {
                    var node = childArray[i];
                    if (node.isExpanded) {
                       harray.push(new Array(getNodeId(node), node.nodeType));
                       harray = _buildExpandedArray(node.children, harray)
                    }
                }
                return harray;
            }

            /* saves expanded state of the tree, reloads the tree and
             * restores the expanded state. !!not to be used after
             * nodes were deleted!!
             */
            function reloadAndKeepExpanded() {
                var ea = getExpandedNodes();
                reloadStructureTree();
                for (var i=0;i<ea.length;i++) {
                    var node = expandToNodeWithId(ea[i][0], isType(ea[i][1]));
                    node.expand();
                }
            }

            /*returns the nodepath as an 2-dim array of nodes and indices, starting from root's
             children upto the node with id ID. The node objects are stored in a 2-dim array,
             where [0] represents the actual node and [1] represents it's index in the parent nodes
             isType controls if the node is an assignment or type
             true for type, false for assignment
             */
            function getNodePath(id, isType) {
                var children = dojo.widget.byId('structureTree').children;
                return searchNode(children,new Array() ,id, isType);
            }

            /*
             * recursively searches for a node with the given id
             * isType controls if the node is an assignment or type
             * true for type, false for assignment
             */
            function searchNode(searcharray, historyarray, id, isType) {
                var foundnode =null;
                for (var i=0;i<searcharray.length && foundnode==null;i++) {
                    var node = searcharray[i];
                    if (node.children) {
                        if (node.children.length >0) {
                           harray = arraycopy(historyarray);
                           harray.push(new Array(node,i));
                           foundnode=searchNode(node.children, harray, id, isType);
                        }
                    }
                    if(isType && node["typeId"]== id || !isType && node["assignmentId"]==id) {
                        foundnode=node;
                        historyarray.push(new Array(node,i));
                        return historyarray;
                    }
                }
                return foundnode;
            }

            function structureTreeClickHandler(node) {
                doContentAction(node, "openInstance");
            }

            //should be invoked by the click handler when normally clicking on tree nodes
            function doContentAction(node, defaultAction) {
                var propertyId = node["assignmentId"] != null ? node["assignmentId"] : node["typeId"];
                if (propertyId != null && propertyId != -1 && parent.frames["contentFrame"].addQueryNode) {
                    // add to search query
                    if (node.nodeType=="AssignmentSystemInternal" || node.nodeType=="Assignment") {
                        if (flexive.util.getJsonRpc().StructureTreeEditor.isSearchable(propertyId))
                            parent.frames["contentFrame"].addQueryNode(propertyId, node.nodeType);
                        else
                            alertDialog("#{fxMessageBean['StructureTree.message.property.notSearchable']}");
                    }
                    else
                        parent.frames["contentFrame"].addQueryNode(propertyId, node.nodeType);
                    //alertDialog("sturctureTreeClickHandler, addProperty branch");
                }
                else doContentActionFromContextMenu(node, defaultAction);
            }

            //should be invoked from the nodes in the context menu
            function doContentActionFromContextMenu(node, defaultAction) {
                if ("Assignment" == node.nodeType || "AssignmentSystemInternal" == node.nodeType) {
                    invokeContentAction("adm/structure/propertyAssignmentEditor.jsf", defaultAction, {id: node["assignmentId"]});
                }
                else if (isType(node.nodeType)) {
                    invokeContentAction("adm/structure/typeEditor.jsf", defaultAction, {id: node["typeId"]});
                }
                else if ("Group" == node.nodeType) {
                    invokeContentAction("adm/structure/groupAssignmentEditor.jsf", defaultAction, {id: node["assignmentId"]});
                }
            }

            function showNode(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                doContentActionFromContextMenu(menu.getTreeNode(), "openInstance");
            }

            function editNode(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                doContentActionFromContextMenu(menu.getTreeNode(), "editInstance");
            }

            // create a new property as child of the current node
            function createProperty(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = getNodeId(menu.getTreeNode());

                invokeContentAction("adm/structure/propertyEditor.jsf", "createProperty", {id: parentId, nodeType: menu.getTreeNode().nodeType});
                //contentPage=null;
            }

            // create a derived type of the current node
            function createDerivedType(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = getNodeId(menu.getTreeNode());

                promptAlias(function(alias) {
                    if (alias!=null && alias!="") {
                        try {
                            newTypeId =flexive.util.getJsonRpc().StructureTreeEditor.createDerivedType(parentId, alias);
                            reloadAndKeepExpanded();
                            selectNode(newTypeId, true);
                        }
                        catch (e) {
                            alertDialog(e.message);
                        }
                    }
                });
            }

             // create a new group as child of the current node
            function createGroup(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = getNodeId(menu.getTreeNode());

                invokeContentAction("adm/structure/groupEditor.jsf", "createGroup", {id: parentId, nodeType: menu.getTreeNode().nodeType});
                //contentPage=null;
            }

            // create a new type
            function createType(menuItem) {
                invokeContentAction("adm/structure/typeEditor.jsf", "createType", {});
                //contentPage=null;
            }

            function createTypeRelation(menuItem) {
                invokeContentAction("adm/structure/typeEditor.jsf", "createTypeRelation", {});
                //contentPage=null;
            }

        /* no longer used
            function assignGroup(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = menu.getTreeNode().assignmentId;

                invokeContentAction("adm/structure/groupAssignmentEditor.jsf", "assignGroup", {id: parentId, nodeType: menu.getTreeNode().nodeType});
                contentPage=null;
            }

            function assignProperty(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = menu.getTreeNode().assignmentId;

                invokeContentAction("adm/structure/propertyAssignmentEditor.jsf", "assignProperty", {id: parentId, nodeType: menu.getTreeNode().nodeType});
                contentPage=null;
            }
          */

            //checks if the structure element opened in the contet frame
            //is still valid (== does still exist).
            function isContentFrameValidAfterDeletion() {
                if (getContentFrame().location.href.indexOf("/flexive/adm/structure/") >0) {
                    var assId=-1; var typeId=-1;
                    if (getContentFrame().document.getElementById("frm:struct_internal_assignmentId") != null)
                        assId = getContentFrame().document.getElementById("frm:struct_internal_assignmentId").value;
                    if (getContentFrame().document.getElementById("frm:struct_internal_typeId") != null)
                        typeId = getContentFrame().document.getElementById("frm:struct_internal_typeId").value;
                    if (assId != -1 && !flexive.util.getJsonRpc().StructureTreeEditor.isAssignmentExists(assId))
                        return false;
                    if (typeId != -1 && !flexive.util.getJsonRpc().StructureTreeEditor.isTypeExists(typeId))
                        return false;
                }
                return true;
            }

            function deleteAssignment(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var id = menu.getTreeNode().assignmentId;
                _deleteAssignment(id);
            }

            function _deleteAssignment(id) {
                confirmDialog("#{fxMessageBean['StructureTree.message.delete.assignment']}", function() {
                    try {
                        flexive.util.getJsonRpc().StructureTreeEditor.deleteAssignment(id);
                        if (copyNode!=null && copyNode.assignmentId ==id && (copyNode.nodeType=="Group" || copyNode.nodeType=="Assignment"))
                            copyNode=null;
                        reloadStructureTree();
                        if (!isContentFrameValidAfterDeletion()) {
                            loadContentPage("adm/structure/content.jsf");
                            parent.gotoNavMenu(1);
                        }
                    }
                    catch (e) {
                        alertDialog(e.message);
                        reloadStructureTree();
                        if (!isContentFrameValidAfterDeletion()) {
                            loadContentPage("adm/structure/content.jsf");
                        }
                    }
                });
            }

            function deleteType(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var id = menu.getTreeNode().typeId;
                _deleteType(id);
            }

            function _deleteType(id) {
                confirmDialog("#{fxMessageBean['StructureTree.message.delete.type']}", function() {
                    try {
                        flexive.util.getJsonRpc().StructureTreeEditor.deleteType(id);
                        reloadStructureTree();
                        reloadContentTreeNavFrame=true;
                        if (!isContentFrameValidAfterDeletion()) {
                            loadContentPage("adm/structure/content.jsf");
                        }
                    }
                    catch (e) {
                        alertDialog(e.message);
                        reloadStructureTree();
                        if (!isContentFrameValidAfterDeletion()) {
                            loadContentPage("adm/structure/content.jsf");
                        }
                    }
                });
            }

            function copyAssignment(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                copyNode = menu.getTreeNode();
                copyMode=true;
                cutMode=false;
            }

            function cutAssignment(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                copyNode = menu.getTreeNode();
                copyMode=false;
                cutMode=true;
            }

            function promptAlias(onSuccess) {
                promptDialog("#{fxMessageBean['StructureTree.message.enterAlias']}", "", function(alias) {
                    var valid = flexive.util.getJsonRpc().StructureTreeEditor.validateAlias(alias);
                    if (!valid) {
                        alertDialog("#{fxMessageBean['StructureTree.message.err.invalidAlias']}");
                    } else {
                        onSuccess(alias);
                    }
                });
            }

            function pasteBelow(menuItem, alias) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var destId = getNodeId(menu.getTreeNode());
                var destNodeType=menu.getTreeNode().nodeType;
                try {
                    if (copyMode) {
                        var newAssignmentId = flexive.util.getJsonRpc().StructureTreeEditor.pasteAssignmentRelative(getNodeId(copyNode), copyNode.nodeType , destId, destNodeType ,alias, 1);
                        reloadAndKeepExpanded();
                        expandToNodeWithId(newAssignmentId, false);
                    }
                    else {
                        flexive.util.getJsonRpc().StructureTreeEditor.moveAssignmentRelative(getNodeId(copyNode), copyNode.nodeType, destId, 1);
                        reloadAndKeepExpanded();
                        expandToNodeWithId(getNodeId(copyNode), false);
                    }
                }
                catch (e) {
                        alertDialog(e.message);
                }
            }

            function pasteBelowAs(menuItem) {
                promptAlias(function(alias) {
                    if (alias!=null && alias!="") {
                        pasteBelow(null, alias);
                    }
                });
            }

            function pasteAbove(menuItem, alias) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var destId = getNodeId(menu.getTreeNode());
                var destNodeType=menu.getTreeNode().nodeType;
                try {
                    if (copyMode) {
                        var newAssignmentId = flexive.util.getJsonRpc().StructureTreeEditor.pasteAssignmentRelative(getNodeId(copyNode), copyNode.nodeType , destId, destNodeType, alias, 0);
                        reloadAndKeepExpanded();
                        expandToNodeWithId(newAssignmentId, false);
                    }
                    else {
                        flexive.util.getJsonRpc().StructureTreeEditor.moveAssignmentRelative(getNodeId(copyNode), copyNode.nodeType, destId, 0);
                        reloadAndKeepExpanded();
                        expandToNodeWithId(getNodeId(copyNode), false);
                    }
                }
                catch (e) {
                        alertDialog(e.message);
                }
            }

            function pasteAboveAs(menuItem) {
                promptAlias(function(alias) {
                    if (alias!=null && alias!="") {
                        pasteAbove(null,alias);
                    }
                });
            }

            function pasteInto(menuItem, alias) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = getNodeId(menu.getTreeNode());
                var parentType= menu.getTreeNode().nodeType;
                try {
                    var newAssignmentId = flexive.util.getJsonRpc().StructureTreeEditor.pasteAssignmentInto(getNodeId(copyNode), copyNode.nodeType , parentId, parentType, alias);
                    reloadAndKeepExpanded();
                    expandToNodeWithId(newAssignmentId, false);
                }
                catch (e) {
                        alertDialog(e.message);
                }
            }

            function pasteIntoAs(menuItem) {
                promptAlias(function(alias) {
                    if (alias!=null && alias!="") {
                        pasteInto(null, alias);
                    }
                });
            }

            function createContent(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var parentId = menu.getTreeNode().typeId;

                invokeContentAction("adm/content/contentEditor.jsf", "newInstance", {typeId: parentId});
                //contentPage=null;
            }

            function getNodeId(node) {
                return node.assignmentId != null
                        ? node.assignmentId
                        : node.typeId;
            }

            function searchContents(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var nodeId = getNodeId(menu.getTreeNode());
                var nodeType = menu.getTreeNode().nodeType;
                var propertyId = menu.getTreeNode().propertyId;

                if (propertyId != null && !flexive.util.getJsonRpc().StructureTreeEditor.isSearchable(propertyId)) {
                    alertDialog("#{fxMessageBean['StructureTree.message.property.notSearchable']}");
                    return;
                }
                if (parent.frames["contentFrame"].isQueryEditor) {
                    // add node to query
                    parent.frames["contentFrame"].addQueryNode(nodeId, nodeType);
                } else {
                    // open query editor
                    if (isType(nodeType)) {
                        invokeContentAction("adm/search/query.jsf", "typeSearch", {typeId: nodeId});
                    } else {
                        invokeContentAction("adm/search/query.jsf", "assignmentSearch", {assignmentId: nodeId});
                    }
                }
                // submit query
                //invokeContentAction("adm/search/searchResult.jsf", "nodeSearch", {nodeId: nodeId});

                //contentPage=null;
            }

            function searchContentsImmediate(menuItem) {
                // show type query results
                var menu = dojo.widget.byId("structureTreeMenu");
                invokeContentAction("adm/search/searchResult.jsf", "typeSearch", {typeId: getNodeId(menu.getTreeNode())});
            }

            function searchContentsByProperty(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var nodeId = menu.getTreeNode().propertyId;
                if (!flexive.util.getJsonRpc().StructureTreeEditor.isSearchable(nodeId)) {
                    alertDialog("#{fxMessageBean['StructureTree.message.property.notSearchable']}");
                    return;
                };
                if (parent.frames["contentFrame"].isQueryEditor) {
                    parent.frames["contentFrame"].addPropertyQueryNode(nodeId);
                } else {
                    invokeContentAction("adm/search/query.jsf", "propertySearch", {propertyId: nodeId});
                }
            }

            function createTestData(menuItem) {
                var menu = dojo.widget.byId("structureTreeMenu");
                var nodeId = getNodeId(menu.getTreeNode());
                if (isType(menu.getTreeNode().nodeType))
                    invokeContentAction("adm/content/createTestData.jsf", "setTypeId", {typeId: nodeId});
            }

            function importType(menuItem) {
                invokeContentAction("adm/structure/structureImport.jsf", "source", "type");
            }

            function exportType(menuItem) {
                try {
                    var menu = dojo.widget.byId("structureTreeMenu");
                    var nodeId = getNodeId(menu.getTreeNode());
                    loadContentPage( "export/type/" + nodeId);
                } catch(ex) {
                    alertDialog(ex)
                }
            }

            //checks if the assignment that is currently being deleted is opened for editing
            //in the content frame
            function checkIfDeletingActiveContent() {
                if (getContentFrame().location.href.contains("/flexive/adm/structure/")) {

                }
            }

            function showTreeMenu() {
                var menu = dojo.widget.byId("structureTreeMenu");
                if (menu.getTreeNode() == null) {
                    return;
                }
                var node = menu.getTreeNode();
                if (!node.nodeType)
                    return;
                var lackRole = #{not fxSystemBean.isInRole['StructureManagement']};
                var notGlobalSupervisor = #{not fxSystemBean.isInRole['GlobalSupervisor']};
                var mayOpen = !lackRole || #{fxSystemBean.isInRole['ScriptManagement']};
                setActionDisabled(menu.getTreeNode(), "editNode", !mayOpen || (node.nodeType =="AssignmentSystemInternal" && notGlobalSupervisor));
                setActionDisabled(menu.getTreeNode(), "createContent", !isType(node.nodeType));
                setActionDisabled(menu.getTreeNode(), "createProperty", !(node.nodeType=="Group" || isType(node.nodeType)) || lackRole);
                setActionDisabled(menu.getTreeNode(), "createGroup", !(node.nodeType=="Group" || isType(node.nodeType)) || lackRole);
                setActionDisabled(menu.getTreeNode(), "createDerivedType", !(node.nodeType=="Type" || lackRole));
                setActionDisabled(menu.getTreeNode(), "deleteAssignment", (node.nodeType!="Group" && node.nodeType!="Assignment") || lackRole || (node.nodeType =="AssignmentSystemInternal" && notGlobalSupervisor));
                setActionDisabled(menu.getTreeNode(), "deleteType", !isType(node.nodeType) || lackRole);
                setActionDisabled(menu.getTreeNode(), "copyAssignment", lackRole || node.nodeType!="Group" && node.nodeType!="Assignment");
                setActionDisabled(menu.getTreeNode(), "searchContents", !isType(node.nodeType) && !isAssignment(node.nodeType));
                setActionDisabled(menu.getTreeNode(), "searchContentsImmediate", !isType(node.nodeType));
                setActionDisabled(menu.getTreeNode(), "searchPropertyContents", !isAssignment(node.nodeType));
                setActionDisabled(menu.getTreeNode(), "cutAssignment", lackRole || node.nodeType!="Assignment" && node.nodeType!="Group");
                //paste a copied assignment node into a different Type below another assignment
                setActionDisabled(menu.getTreeNode(), "pasteBelow", lackRole || copyNode==null || cutMode || (copyMode && (node.nodeType!="Assignment" && node.nodeType!="Group") ||
                                flexive.util.getJsonRpc().StructureTreeEditor.isSameLevel(copyNode.assignmentId, node.assignmentId)));
                //only allowed at same level/Type and if the node is different than the right clicked node
                setActionDisabled(menu.getTreeNode(), "pasteBelowAfterCut", lackRole || copyNode==null || copyMode || (node.nodeType!="Assignment" && node.nodeType!="Group") ||
                                getNodeId(copyNode) == getNodeId(node) ||(cutMode && !flexive.util.getJsonRpc().StructureTreeEditor.isSameLevel(copyNode.assignmentId, node.assignmentId)));
                //paste a copied assignment node into a different Type above another assignment
                setActionDisabled(menu.getTreeNode(), "pasteAbove", lackRole || copyNode==null || cutMode || (copyMode && (node.nodeType!="Assignment" && node.nodeType!="Group") ||
                                flexive.util.getJsonRpc().StructureTreeEditor.isSameLevel(copyNode.assignmentId, node.assignmentId)));
                //only allowed at same level/Type and if the node is different than the right clicked node
                setActionDisabled(menu.getTreeNode(), "pasteAboveAfterCut", lackRole || copyNode==null || copyMode || (node.nodeType!="Assignment" && node.nodeType!="Group") ||
                                getNodeId(copyNode) == getNodeId(node) || (cutMode && !flexive.util.getJsonRpc().StructureTreeEditor.isSameLevel(copyNode.assignmentId, node.assignmentId)));
                setActionDisabled(menu.getTreeNode(), "pasteInto", lackRole || copyNode==null || cutMode || (!isType(node.nodeType) && node.nodeType!="Group") ||
                                flexive.util.getJsonRpc().StructureTreeEditor.isChild(copyNode.assignmentId, getNodeId(node), node.nodeType));
                setActionDisabled(menu.getTreeNode(), "pasteBelowAs", lackRole || copyNode==null || cutMode ||(node.nodeType!="Assignment" && node.nodeType!="Group"));
                setActionDisabled(menu.getTreeNode(), "pasteAboveAs", lackRole || copyNode==null || cutMode ||(node.nodeType!="Assignment" && node.nodeType!="Group"));
                setActionDisabled(menu.getTreeNode(), "pasteIntoAs", lackRole || copyNode==null || cutMode || (!isType(node.nodeType) && node.nodeType!="Group"));
                setActionDisabled(menu.getTreeNode(), "pasteSubMenu", lackRole || copyNode==null || cutMode);
                setActionDisabled(menu.getTreeNode(), "createTestData", lackRole || !isType(node.nodeType));
                setActionDisabled(menu.getTreeNode(), "exportType", lackRole || !isType(node.nodeType));
                menu.show_();
            }

            function isType(nodeType) {
                return nodeType.indexOf("Type") == 0;
            }

            function isAssignment(nodeType) {
                return nodeType == "Assignment" || nodeType == "AssignmentSystemInternal";
            }

            function enableSearchMode() {
                setBackgroundImage("adm/images/tree/background_search.png");
            }

            function disableSearchMode() {
                removeBackgroundImage();
            }
                
            dojo.addOnLoad(function() {
                if (getContentFrame().isQueryEditor) {
                    enableSearchMode();
                }
            });
        //-->
		</script>
        <div style="display:none;"><iframe id="exportFrame" ><!--empty--></iframe></div>
        <adm:tree name="structureTree" targetId="structureTreeContainer"  extensionPoint="/tree/adm/structure"
                  clickHandler="structureTreeClickHandler" docIcons="true" expandFirstNode="false">

            <adm:treeContextMenu showHandler="showTreeMenu">
                <adm:treeContextMenuItem icon="open" treeActions="showNode" labelKey="StructureTree.menu.open" clickHandler="showNode"/>
                <adm:treeContextMenuItem icon="edit" treeActions="editNode" labelKey="StructureTree.menu.edit" clickHandler="editNode"/>
                <adm:treeContextMenuItem icon="export" treeActions="exportType" labelKey="StructureTree.menu.exportType" clickHandler="exportType"/>
                <adm:treeContextMenuItem icon="property" treeActions="createProperty" labelKey="StructureTree.menu.createProperty" clickHandler="createProperty"/>
                <adm:treeContextMenuItem icon="group" treeActions="createGroup" labelKey="StructureTree.menu.createGroup" clickHandler="createGroup" />
                <adm:treeContextMenuItem icon="fxType" treeActions="createDerivedType" labelKey="StructureTree.menu.createDerivedType" clickHandler="createDerivedType" />
                <adm:treeContextMenuItem icon="search" treeActions="searchContents" labelKey="StructureTree.menu.searchContents" clickHandler="searchContents"/>
                <adm:treeContextMenuItem icon="search" treeActions="searchContentsImmediate" labelKey="StructureTree.menu.searchContentsImmediate" clickHandler="searchContentsImmediate"/>
                <adm:treeContextMenuItem icon="search" treeActions="searchPropertyContents" labelKey="StructureTree.menu.searchContents.property" clickHandler="searchContentsByProperty"/>
                <fx:dojoMenuSeparator/>
                <adm:treeContextMenuItem icon="new" treeActions="createContent" labelKey="ContentTree.menu.create" clickHandler="createContent"/>
                <adm:treeContextMenuItem icon="createTestData" treeActions="createTestData" labelKey="StructureTree.menu.createTestData" clickHandler="createTestData" />
                <fx:dojoMenuSeparator/>
                <adm:treeContextMenuItem treeActions="copyAssignment" icon="copy" labelKey="StructureTree.menu.copyAssignment" clickHandler="copyAssignment"/>
                <adm:treeContextMenuItem treeActions="pasteInto" icon="paste" labelKey="StructureTree.menu.paste.into" clickHandler="pasteInto"/>
                <adm:treeContextMenuItem treeActions="pasteAboveAfterCut" icon="paste" labelKey="StructureTree.menu.paste.above" clickHandler="pasteAbove"/>
                <adm:treeContextMenuItem treeActions="pasteBelowAfterCut" icon="paste" labelKey="StructureTree.menu.paste.below" clickHandler="pasteBelow"/>
                <adm:treeContextMenuItem treeActions="pasteSubMenu" icon="paste" labelKey="StructureTree.menu.paste.submenu">
                    <adm:treeContextMenuItem treeActions="pasteAbove" icon="paste" labelKey="StructureTree.menu.paste.above" clickHandler="pasteAbove"/>
                    <adm:treeContextMenuItem treeActions="pasteBelow" icon="paste" labelKey="StructureTree.menu.paste.below" clickHandler="pasteBelow"/>
                    <adm:treeContextMenuItem treeActions="pasteInto" icon="paste" labelKey="StructureTree.menu.paste.into" clickHandler="pasteInto"/>
                    <fx:dojoMenuSeparator/>
                    <adm:treeContextMenuItem treeActions="pasteAboveAs" icon="paste" labelKey="StructureTree.menu.paste.aboveAs" clickHandler="pasteAboveAs"/>
                    <adm:treeContextMenuItem treeActions="pasteBelowAs" icon="paste" labelKey="StructureTree.menu.paste.belowAs" clickHandler="pasteBelowAs"/>
                    <adm:treeContextMenuItem treeActions="pasteIntoAs" icon="paste" labelKey="StructureTree.menu.paste.intoAs" clickHandler="pasteIntoAs"/>
                </adm:treeContextMenuItem>
                <adm:treeContextMenuItem icon="cut" treeActions="cutAssignment" labelKey="StructureTree.menu.cut.assignment" clickHandler="cutAssignment"/>
                <adm:treeContextMenuItem icon="delete" treeActions="deleteAssignment" labelKey="StructureTree.menu.delete.assignment" clickHandler="deleteAssignment"/>
                <adm:treeContextMenuItem icon="delete" treeActions="deleteType" labelKey="StructureTree.menu.delete.type" clickHandler="deleteType"/>
            </adm:treeContextMenu>

            <adm:jsonRpcCall method="StructureTreeWriter.renderStructureTree" args="-1"/>
    	</adm:tree>
    	
        <div id="structureTreeContainer">
        </div>
    </ui:define>

    <ui:define name="mainMenu">
        <div class="menu">
            <fx:dojoMenu name="mainMenu">

                <fx:dojoMenuItem rendered="#{fxSystemBean.isInRole['StructureManagement']}" labelKey="StructureTree.menu.createType" icon="windowNew" clickHandler="function(menuItem) { createType(menuItem); }"/>
                <fx:dojoMenuItem rendered="#{fxSystemBean.isInRole['StructureManagement']}" labelKey="StructureTree.menu.createTypeRelation" icon="fxTypeRelation" clickHandler="function(menuItem) { createTypeRelation(menuItem); }"/>
                <fx:dojoMenuItem rendered="#{fxSystemBean.isInRole['StructureManagement']}" labelKey="StructureTree.menu.importType" icon="importContent" clickHandler="importType"/>

                <fx:dojoMenuSeparator/>

                <ui:include src="/adm/templates/navigation.menu.tabs.xhtml"/>
            </fx:dojoMenu>
        </div>
    </ui:define>

    <ui:define name="reloadButton">
        <a href="javascript:reloadStructureTree()"><t:graphicImage url="/adm/images/layout/reload.png" alt="reload" style="position:absolute;right:15px;margin-top:2px;border:0;"/></a>
    </ui:define>

</ui:composition>


</html>
        