<?xml version="1.0" encoding="UTF-8"?>
<project>

    <!-- ==================== Some common macros ==================== -->
    <macrodef name="replaceBuildProperties" description="Replaces build properties of the current build (subversion number, build user, timestamp) in a text file.">
        <attribute name="file" description="The text file to be processed."/>
        <attribute name="buildnumber" description="The build number to be inserted"/>
        <attribute name="buildtime" description="The build time to be inserted"/>
        <sequential>
            <replace file="@{file}">
                <replacefilter token="@@@build.number@@@" value="@{buildnumber}"/>
                <replacefilter token="@@@build.user@@@" value="${user.name}"/>
                <replacefilter token="@@@build.date@@@" value="@{buildtime}"/>
            </replace>
        </sequential>
    </macrodef>

    <macrodef name="buildScriptIndex">
        <attribute name="dir" description="The scripts base directory. Should include subfolders runonce, startup and library."/>
        <sequential>
            <scriptIndexBuilder indexFile="@{dir}/runonce/scriptindex.flexive" scriptDir="@{dir}/runonce"/>
            <scriptIndexBuilder indexFile="@{dir}/library/scriptindex.flexive" scriptDir="@{dir}/library"/>
            <scriptIndexBuilder indexFile="@{dir}/startup/scriptindex.flexive" scriptDir="@{dir}/startup"/>
        </sequential>
    </macrodef>

    <!-- ==================== Database maintenance macros ==================== -->
    <macrodef name="sql-call" description="Executes nested SQL statements. The database host, user and password are configured with the properties database.host, database.port, database.username, database.password">
        <attribute name="database"/>
        <attribute name="includes" default="N/A"/>
        <attribute name="excludes" default=""/>
        <attribute name="delimiter" default=";"/>
        <element name="args" optional="true" implicit="true"/>
        <sequential >
            <sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://${database.host}:${database.port}/@{database}?useUnicode=true&amp;characterEncoding=UTF-8"
                userid="${database.username}" password="${database.password}" delimiter="@{delimiter}">
                <classpath refid="${mysql.classpathref}"/>
                <args/>
                <sort>
                    <fileset dir="${mysql.src.dir}" includes="@{includes}" excludes="@{excludes}"/>
                </sort>
            </sql>
        </sequential>
    </macrodef>

    <macrodef name="division-setup" description="Creates all database structures for the given database name">
        <attribute name="database" description="The database name"/>
        <sequential >
            <sql-call database="mysql">
                <transaction >
                    DROP SCHEMA IF EXISTS @{database};
                    CREATE SCHEMA @{database};
                </transaction>
            </sql-call>

            <sql-call database="@{database}" includes="*.sql" excludes="SP*.sql"/>
            <!-- Stored procedures setup -->
            <sql-call database="@{database}" delimiter="|" includes="SP*.sql"/>
            <sql-call database="@{database}" delimiter="|" includes="tree/*.sql"/>

            <echo taskname="flexive">Successfully initialized a flexive division at jdbc:mysql://${database.host}:${database.port}/@{database}</echo>
        </sequential>
    </macrodef>

    <macrodef name="globalconfig-setup" description="The global configuration setup.">
        <sequential >
            <!-- Create global configuration -->
            <sql-call database="mysql">
                <transaction >
                    DROP SCHEMA IF EXISTS flexiveConfiguration;
                    CREATE SCHEMA flexiveConfiguration;
                </transaction>
            </sql-call>
            <sql-call database="flexiveConfiguration" includes="config/*.sql"/>
            <echo taskname="flexive">Successfully initialized a the flexive configuration database at jdbc:mysql://${database.host}:${database.port}/flexiveConfiguration</echo>
        </sequential>
    </macrodef>

    <!-- ==================== UI plugin/component macros ==================== -->

    <macrodef name="buildPluginJar">
        <attribute name="name"/>
        <attribute name="srcdir"/>
        <attribute name="jarfile"/>
        <sequential>
            <makeMessages srcdir="@{srcdir}/resources/messages" dest="${build.ui.components.dir}/@{name}/PluginMessages"/>
            <jar jarfile="@{jarfile}">
                <fileset dir="@{srcdir}/resources" includes="META-INF/**/*,templates/**/*"/>
                <fileset dir="${build.ui.components.dir}/@{name}" includes="*.properties"/>
                <fileset dir="${build.ui.components.dir}/@{name}/classes"/>
                <fileset dir="@{srcdir}/resources/weblets" includes="**/*"/>
                <fileset dir="@{srcdir}/web" includes="**/*"/>
            </jar>
        </sequential>
    </macrodef>

    <macrodef name="compilePlugin">
        <attribute name="name"/>
        <attribute name="srcdir"/>
        <sequential>
            <mkdir dir="${build.ui.components.dir}/@{name}"/>
            <javac-call
                srcdir="@{srcdir}/src/java"
                destdir="${build.ui.components.dir}/@{name}/classes">
                <classpath>
                    <path path="${build.framework.classes.dir}"/>
                    <path path="${build.ui.shared.classes.dir}"/>
                    <path path="${build.ui.components.dir}/jsf-core/classes"/>
                </classpath>
                <classpath refid="classpath.build.framework"/>
            </javac-call>
        </sequential>
    </macrodef>

    <macrodef name="buildPlugin">
        <attribute name="name"/>
        <attribute name="srcdir"/>
        <sequential>
            <compilePlugin name="@{name}" srcdir="@{srcdir}"/>
            <buildPluginJar name="@{name}" jarfile="${build.ui.jar.dir}/flexive-plugin-@{name}.jar" srcdir="@{srcdir}"/>
        </sequential>
    </macrodef>


</project>