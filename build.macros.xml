<?xml version="1.0" encoding="UTF-8"?>
<project>

    <macrodef name="javac-call" description="Invokes the Java compiler for flexive sources. The classpath can be set with nested classpath elements.">
		<attribute name="srcdir"/>
		<attribute name="destdir"/>
		<attribute name="excludes" default="NONE"/>
		<attribute name="includes" default="**/*.java"/>
		<element name="args" optional="true" implicit="true"/>
		<sequential>
			<mkdir dir="@{destdir}"/>
			<javac  srcdir="@{srcdir}"
                    destdir="@{destdir}"
                    debug="${compiler.debug}"
                    deprecation="${compiler.deprecation}"
                    optimize="${compiler.optimize}"
                    includes="@{includes}"
                    excludes="@{excludes}"
                    source="${compiler.source}"
                    target="${compiler.target}"
                    fork="${compiler.fork}">
				<args/>
			</javac>
		</sequential>
	</macrodef>


    <!-- ==================== Some common macros ==================== -->
    <macrodef name="replaceBuildProperties" description="Replaces build properties of the current build (subversion number, build user, timestamp) in a text file.">
        <attribute name="file" description="The text file to be processed."/>
        <attribute name="buildnumber" description="The build number to be inserted"/>
        <attribute name="buildtime" description="The build time to be inserted"/>
        <sequential>
            <replace file="@{file}">
                <replacefilter token="@@@build.number@@@" value="@{buildnumber}"/>
                <replacefilter token="@@@build.user@@@" value="${user.name}"/>
                <replacefilter token="@@@build.date@@@" value="@{buildtime}"/>
            </replace>
        </sequential>
    </macrodef>

    <macrodef name="buildScriptIndex">
        <attribute name="dir" description="The scripts base directory. Should include subfolders runonce, startup and library."/>
        <sequential>
            <scriptIndexBuilder indexFile="@{dir}/runonce/scriptindex.flexive" scriptDir="@{dir}/runonce"/>
            <scriptIndexBuilder indexFile="@{dir}/library/scriptindex.flexive" scriptDir="@{dir}/library"/>
            <scriptIndexBuilder indexFile="@{dir}/startup/scriptindex.flexive" scriptDir="@{dir}/startup"/>
        </sequential>
    </macrodef>

    <!-- ==================== Database maintenance macros ==================== -->
    <macrodef name="sql-call"
              description="Executes nested SQL statements. The database host, user and password are configured with the properties database.host, database.port, database.username, database.password">
        <attribute name="database"/>
        <attribute name="url"/>
        <attribute name="includes" default="N/A"/>
        <attribute name="excludes" default=""/>
        <attribute name="delimiter" default=";"/>
        <element name="args" optional="true" implicit="true"/>
        <sequential >
            <echo  message="dir: ${flexive.build.framework.sqlResources.dir}"/>
            <sql driver="${database.driver}" url="@{url}"
                userid="${database.username}" password="${database.password}" delimiter="@{delimiter}">
                <classpath refid="${database.classpathref}"/>
                <args/>
                <sort>
                    <fileset dir="${flexive.build.framework.sqlResources.dir}" includes="@{includes}" excludes="@{excludes}"/>
                </sort>
            </sql>
        </sequential>
    </macrodef>

    <macrodef name="division-setup" description="Creates all database structures for the given database name">
        <attribute name="database" description="The database name"/>
        <sequential >
            <groovy>
                <arg value="@{database}"/>
                if( "H2".equals(properties['database.vendor']) ) {
                    //special case for H2: the URL needs to contain the schema which is the database name
                    //to be created
                    properties['database.url.create'] = properties['database.url.base'] + args[0]    
                } else
                    properties['database.url.create'] = properties['database.url.base']
            </groovy>
            <!-- call with no url parameters to allow schema creation -->
            <sql-call database="${database.schema.root}" url="${database.url.create}">
                <transaction >
                    DROP SCHEMA IF EXISTS @{database};
                    CREATE SCHEMA @{database};
                </transaction>
            </sql-call>
            <!-- Replace URL parameters @DATABASE@ with @{Database}-->
            <groovy>
                <arg value="@{database}"/>
                properties['db.url.full'] = properties['database.url.base']+args[0]+properties['database.url.parameters']
                properties['db.url.full'] = properties['db.url.full'].replace("@DATABASE@", args[0])
            </groovy>
            <sql-call database="${database.schema.root}" includes="*.sql" excludes="SP*.sql"
                    url="${db.url.full}"/>
            <!-- Stored procedures setup -->
            <sql-call database="@{database}" delimiter="|" includes="SP*.sql"
                    url="${db.url.full}"/>
            <sql-call database="@{database}" delimiter="|" includes="tree/*.sql"
                    url="${db.url.full}"/>

            <echo taskname="flexive">Successfully initialized a flexive division at ${database.url.base}@{database}</echo>
        </sequential>
    </macrodef>

    <macrodef name="globalconfig-setup" description="The global configuration setup.">
        <sequential >
            <groovy>
                <arg value="@{database}"/>
                if( "H2".equals(properties['database.vendor']) ) {
                    //special case for H2: the URL needs to contain the schema which is the database name
                    //to be created
                    properties['database.url.create'] = properties['database.url.base'] + 'flexiveConfiguration'
                } else
                    properties['database.url.create'] = properties['database.url.base']
            </groovy>
            <!-- Create global configuration -->
            <sql-call database="${database.schema.config}"  url="${database.url.create}">
                <transaction >
                    DROP SCHEMA IF EXISTS flexiveConfiguration;
                    CREATE SCHEMA flexiveConfiguration;
                </transaction>
            </sql-call>
            <sql-call database="flexiveConfiguration" includes="config/*.sql"  url="${database.url.base}flexiveConfiguration"/>
            <echo taskname="flexive">Successfully initialized a the flexive configuration database at ${database.url.base}flexiveConfiguration</echo>
        </sequential>
    </macrodef>

    <!-- ==================== UI plugin/component macros ==================== -->

    <macrodef name="buildPluginJar" description="Package a plugin JAR file">
        <attribute name="name"/>
        <attribute name="srcdir"/>
        <attribute name="builddir"/>
        <attribute name="jarfile"/>
        <element name="jar-elements" optional="true"/>
        <sequential>
            <makeMessages srcdir="@{srcdir}/resources/messages" dest="@{builddir}/PluginMessages"/>
            <buildScriptIndex dir="@{srcdir}/resources/scripts"/>
            <delete dir="@{builddir}/component-config"/>
            <copy todir="@{builddir}/component-config">
                <fileset dir="@{srcdir}/resources" includes="META-INF/**/*,templates/**/*"/>
                <fileset dir="@{builddir}" includes="*.properties"/>
                <filterset >
                    <filter token="FLEXIVE_VERSION" value="${flexive.version}"/>
                </filterset>
            </copy>
            <jar jarfile="@{jarfile}">
                <fileset dir="@{builddir}/component-config" includes="**/*"/>
                <fileset dir="@{builddir}/classes"/>
                <fileset dir="@{srcdir}/resources/weblets" includes="**/*"/>
                <fileset dir="@{srcdir}/web" includes="**/*"/>

                <zipfileset dir="@{srcdir}/resources/scripts" prefix="@{name}Resources/scripts" includes="**/*"/>
                <jar-elements/>
            </jar>
        </sequential>
    </macrodef>

    <macrodef name="compilePlugin" description="Compile the plugin sources">
        <attribute name="srcdir"/>
        <attribute name="builddir"/>
        <attribute name="classpathref"/>
        <sequential>
            <mkdir dir="@{builddir}/classes"/>
            <javac-call
                srcdir="@{srcdir}/src/java"
                destdir="@{builddir}/classes">
                <classpath refid="@{classpathref}"/>
            </javac-call>
        </sequential>
    </macrodef>

    <macrodef name="buildStorage" description="Compile storage sources and package them">
        <attribute name="srcdir" description="Base directory of the storage"/>
        <attribute name="builddir" description="Directory to generate the artifacts at"/>
        <attribute name="classpathref" description="Reference to the [fleXive] classpath"/>
        <attribute name="jarfile" description="Resulting jar file"/>
        <sequential>
            <mkdir dir="@{builddir}/classes"/>
            <javac-call
                srcdir="@{srcdir}/java"
                destdir="@{builddir}/classes">
                <classpath refid="@{classpathref}"/>
            </javac-call>
            <jar jarfile="@{jarfile}">
                <fileset dir="@{builddir}/classes"/>
                <zipfileset dir="@{srcdir}/resources" prefix="resources" includes="**/*sql"/>
                <zipfileset dir="@{srcdir}/resources" includes="**/*properties"/>
            </jar>
        </sequential>
    </macrodef>

    <!-- ========================= Deployment ========================== -->
    <macrodef name="deployToJetty" description="Deploy an EAR file to a Jetty installation">
        <attribute name="earfile"/>
        <attribute name="jettydir"/>
        <sequential >
            <!-- Clear EJB deployment directory -->
            <delete  dir="@{jettydir}/lib/ext/flexive"/>
            
            <!-- Unzip EJBs and libraries to lib/ext -->
            <unzip dest="@{jettydir}/lib/ext/flexive" overwrite="true" src="@{earfile}">
                <patternset>
                    <include name="lib/**"/>
                    <include name="*-ejb.jar"/>
                    <include name="lib/*-ejb.jar"/>
                </patternset>
            </unzip>

            <!-- Install WAR applications to webapps -->
            <unzip dest="@{jettydir}/webapps" overwrite="true" src="@{earfile}">
                <patternset>
                    <include name="*.war"/>
                </patternset>
            </unzip>

            <!-- Install JSF runtime -->
            <copy todir="@{jettydir}/lib/ext/flexive-environment">
                <fileset dir="${dist.basedir}/extlib" includes="jsf-api.jar,jsf-impl.jar,el-api.jar,el-ri.jar"/>
            </copy>
            
        </sequential>
    </macrodef>

    <macrodef name="runJetty" description="Launch Jetty with OpenEJB">
        <attribute name="jettydir"/>
        <sequential >
            <java dir="@{jettydir}" fork="true" jar="@{jettydir}/start.jar">
                <!-- Don't force -server because default Java installations may not have the server VM -->
                <!--<jvmarg value="-server"/>-->
                <jvmarg value="-Xmx128m"/>
                <jvmarg value="-Dopenejb.configuration=openejb.conf.xml"/>
            </java>
        </sequential>
    </macrodef>

    <macrodef name="createFlatStorage" description="Create a new flat storage table">
        <attribute name="jar" description="Path to flatStorageCreator.jar"/>
        <attribute name="lib" description="Path to the folder containing the shared flexive libraries (flexive-shared.jar)"/>
        <attribute name="extlib" description="Path to external library directory containing the dependencies for FlatStorageCreator.java"/>
        <attribute name="connectionUrl" description="The database connection URL"/>
        <attribute name="schema" description="Database schema (not applicable to all DB vendors)"/>
        <attribute name="tableName" description="Name of the table to be created"/>
        <attribute name="overwrite" default="false" description="If an existing table should be overwritten (true or false)"/>
        <attribute name="user" description="The database user"/>
        <attribute name="password" description="The database password"/>
        <attribute name="nstring" default="20" description="Number of STRING columns"/>
        <attribute name="ntext" default="10" description="Number of TEXT columns"/>
        <attribute name="nbigint" default="10" description="Number of BIGINT columns"/>
        <attribute name="ndouble" default="10" description="Number of DOUBLE columns"/>
        <attribute name="nselect" default="10" description="Number of SELECT columns"/>
        <sequential >
            <path id="createFlatStorage.classpath">
                <fileset file="@{jar}"/>
                <fileset dir="@{extlib}" includes="*.jar"/>
                <fileset dir="@{lib}" includes="*.jar"/>
            </path>
            <java fork="true" classpathref="createFlatStorage.classpath" classname="com.flexive.tools.FlatStorageCreator">
                <arg line="-u @{user}"/>
                <arg line="--password=@{password}"/>
                <arg value="-o"/>
                <arg line="-nstring @{nstring}"/>
                <arg line="-ntext @{ntext}"/>
                <arg line="-nbigint @{nbigint}"/>
                <arg line="-ndouble @{ndouble}"/>
                <arg line="-nselect @{nselect}"/>
                <arg value="@{connectionUrl}"/>
                <arg value="@{schema}"/>
                <arg value="@{tableName}"/>
                <jvmarg value="-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.Log4JLogger"/>
                <jvmarg value="-Dlog4j.configuration=flatStorageLog4j.xml"/>
            </java>
        </sequential>
    </macrodef>
</project>