<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter [
        <!ENTITY % global_entities SYSTEM "global.ent">
        %global_entities;
        ]>
<chapter xml:id="installation" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude">

    <title>Installing &Flexive;
    </title>

    <xi:include href="includes/author_hbacher.xml"/>

    <section xml:id="prerequisites">
        <title>Prerequisites</title>

        <xi:include href="includes/installation_prerequisites.xml"/>

        <section xml:id="develop_flexive">
            <title>
                To develop &Flexive; you need...
            </title>
            <para>
                If you are interested in developing &Flexive;, you will need the
                <link xlink:href="http://www.flexive.org/download">&Flexive; source code
                </link>
                and an IDE like
                <link xlink:href="http://www.eclipse.org/">Eclipse</link>,
                <link xlink:href="http://www.netbeans.org/">Netbeans</link> or
                <link xlink:href="http://www.jetbrains.com/idea">IDEA</link>.
            </para>
            <para>The following sections are good starting points for future &Flexive; developers:</para>
            <para>
                <itemizedlist>
                    <listitem>
                        <para>
                            <link linkend="building_from_source">Building &Flexive; from source</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link linkend="tutorial">The &flexive; Tutorial</link>
                        </para>
                    </listitem>
                    <listitem>
                        <para>
                            <link linkend="writing_applications">Writing &flexive; applications</link>
                        </para>
                    </listitem>
                </itemizedlist>
                We provide the current generated
                <link xlink:href="http://www.flexive.org/documentation/api-documentation.html">&Flexive; API
                    Documentation
                </link>
                for you on our
                <link xlink:href="http://www.flexive.org">website</link>.
            </para>
        </section>
    </section>
    <section xml:id="jboss_installation">
        <title>&Flexive; installation guide for JBoss 4.2.2 GA
        </title>
        <section xml:id="jboss_installation_required_libs">
            <title>Required libraries</title>
            <para>The following required libraries have to be deployed:</para>
            <para>Copy the following file from the
                <filename>extlib</filename>
                directory of your &Flexive; binary distribution to
                <filename>${jboss.home}/server/default/lib</filename>:
            </para>
            <itemizedlist>
                <listitem>
                    <para>
                        <filename>mysql-connector-java-*.jar</filename>
                        (Alternatively you can download the latest stable
                        <link xlink:href="http://dev.mysql.com/downloads/connector/j/5.0.html">MySQL JDBC
                            driver</link>)
                    </para>
                </listitem>
                <listitem>
                    <para>
                        or
                        <filename>h2.jar</filename>
                        if you are using the H2 database.
                    </para>
                </listitem>
            </itemizedlist>
        </section>
        <section xml:id="jboss_installation_system_configuration">
            <title>System configuration</title>
            <para>
                <itemizedlist>
                    <listitem>
                        <para>Create and copy the datasource config file
                            <filename>flexive-ds.xml</filename>
                            to
                            <filename>${jboss.home}/server/default/deploy/</filename>
                            and adapt to your datasource(s)
                            or simply copy it from the &Flexive; source tree, if available.
                            For the H2 database, we provide the
                            <filename>flexive-h2-ds.xml</filename>
                            configuration file as a template.
                            In the
                            <filename>flexive-[h2-]ds.xml</filename>
                            configure your database connections as follows if using MySQL:
                            For the
                            <code>flexive</code>
                            database
                            <xi:include href="listings/installation_flexive-ds_config_flexive.xml"/>
                            For the
                            <code>flexiveConfiguration</code>
                            database
                            <xi:include href="listings/installation_flexive-ds_config_flexiveConfiguration.xml"/>
                            <filename>flexive-ds.xml</filename>
                            <programlisting language="xml">
                                <xi:include href="../../src/framework/resources/jboss/flexive-ds.xml" parse="text"/>
                            </programlisting>

                            If you are using H2 please apply the following settings:
                            <programlisting language="xml">
                                <xi:include href="../../src/framework/resources/jboss/flexive-h2-ds.xml" parse="text"/>
                            </programlisting>
                        </para>
                    </listitem>
                </itemizedlist>
            </para>
        </section>
        <section xml:id="jboss_installation_db_setup">
            <title>Database Setup
            </title>
            <para>
                To set up the databases do the following
            </para>
            <itemizedlist>
                <listitem>
                    <para>Adapt the
                        <filename>database.properties</filename>
                        file located in your
                        <filename>flexive-dist</filename>
                        directory of your &Flexive; distribution to your needs:
                        <programlisting><![CDATA[
# This is the database configuration file used by the flexive setup tasks.
#
# Enter the settings for your database server connection to be used for development.
# Please use the database.vendor property at the bottom of this file to select
# the database vendor to use.

# MySQL database settings

# The server host or IP
database.MySQL.host=localhost
# The server port
database.MySQL.port=3306
# The user name and password to be used for creating flexive database structures
database.MySQL.username=root
database.MySQL.password=a
# The root schema where the flexive schemas can be dropped and created
database.MySQL.schema.root=mysql
database.MySQL.schema.config=mysql
# JDBC Driver
database.MySQL.driver=com.mysql.jdbc.Driver
# JDBC base URL, will be appended by the database name and the url parameters
database.MySQL.url.base=jdbc:mysql://${database.MySQL.host}:${database.MySQL.port}/
# Optional URL parameters to append to the JDBC connect string
database.MySQL.url.parameters=?useUnicode=true&amp;characterEncoding=UTF-8

# H2 database settings

# The server host or IP
database.H2.host=localhost
# The server port
database.H2.port=9092
# The user name and password to be used for creating flexive database structures
database.H2.username=sa
database.H2.password=
database.H2.schema.root=flexive
database.H2.schema.config=flexiveConfiguration
database.H2.driver=org.h2.Driver
database.H2.url.base=jdbc:h2:tcp://${database.H2.host}:${database.H2.port}/~/
database.H2.url.parameters=;SCHEMA=@DATABASE@;MVCC=TRUE


#select the database vendor to use
#database.vendor=H2
database.vendor=MySQL]]></programlisting>
                        <filename>database.properties</filename>
                        contains settings for all currently supported database vendors of &Flexive;. You can adapt the
                        setting like choosing different ports or locations for the database.
                        The probably most important setting are the lines at the end of the file:
                        <programlisting><![CDATA[
#select the database vendor to use
#database.vendor=H2
database.vendor=MySQL]]></programlisting>
                        Here you can select the database vendor to use by commenting out the appropriate line. In this
                        example MySQL is the database vendor to be used.
                    </para>
                </listitem>
                <listitem>
                    <para>Change to the
                        <filename>flexive-dist</filename>
                        directory of your &Flexive; distribution and run
                        <command>ant db.create db.config.create</command>
                    </para>
                    <para>You will be prompted to enter a name for your division database (simply hit enter to keep
                        <filename>flexive</filename>).
                    </para>
                    <para>
                        <emphasis>Warning:</emphasis>
                        Existing databases will be deleted.
                    </para>
                </listitem>
            </itemizedlist>
        </section>
        <section xml:id="jboss_installation_deployment">
            <title>Deployment</title>
            <para>Change to the
                <filename>flexive-dist</filename>
                directory of your &Flexive; distribution and run
                <command>ant ear</command>. This will create the
                <filename>flexive.ear</filename>
                file inside the
                <filename>flexive-dist</filename>
                directory. Copy
                <filename>flexive.ear</filename>
                to
                <filename>${jboss.home}/server/default/deploy</filename>.
            </para>
        </section>
        <section xml:id="jboss_installation_starting_flexive">
            <title>Starting &Flexive;
            </title>
            <itemizedlist>
                <listitem>
                    <para>Currently JBoss 4.2.x uses the Java's default maximum heap size,
                        which means that &flexive; will probably run out of memory during the
                        first startup. You have to set the maximum heap size using
                        <code>-Xmx</code>
                        to a larger value, at least 256m.
                    </para>
                    <para>On Linux execute
                        <programlisting><![CDATA[export JAVA_OPTS="-Xms128m -Xmx512m"]]></programlisting>
                    </para>
                    <para>On Windows execute
                        <programlisting><![CDATA[SET JAVA_OPTS=-Xms128m -Xmx512m]]></programlisting>
                    </para>
                </listitem>
                <listitem>
                    <para>Change to the
                        <filename>${jboss.home}/bin</filename>
                        directory.
                    </para>
                    <para>
                        On Linux launch JBoss using
                        <programlisting><![CDATA[sh run.sh -c default -Djboss.bind.address=0.0.0.0]]></programlisting>
                    </para>
                    <para>
                        On Windows launch JBoss using
                        <programlisting><![CDATA[start run.bat -c default -Djboss.bind.address=0.0.0.0]]></programlisting>
                    </para>
                </listitem>
                <listitem>
                    <para>To access the backend point your browser to
                        <link xlink:href="http://localhost:8080/flexive/adm/">http://localhost:8080/flexive/adm/</link>
                    </para>
                    <para>Alternatively you can specify your server's IP address, which is supported by default,
                        too.
                    </para>
                </listitem>
                <listitem>
                    <para>
                        The default superuser's username and password for the Backend Administration are:
                    </para>
                    <para>username: supervisor, password: supervisor</para>
                </listitem>
            </itemizedlist>
        </section>
        <section xml:id="jboss_installation_system_configuration_refining">
            <title>Refining your configuration</title>
            <itemizedlist>
                <listitem>
                    <para>Extend
                        <filename>${jboss.home}/server/default/conf/jboss-log4j.xml</filename>
                        to configure logging:
                        <xi:include href="listings/installation_jboss-log4j.xml"/>
                    </para>
                </listitem>
                <listitem>
                    <para>Optional if you need JAAS support: Extend
                        <filename>${jboss.home}/server/default/conf/login-config.xml</filename>
                        with the following entry:
                        <xi:include href="listings/installation_login-config.xml"/>
                    </para>
                </listitem>
                <listitem>
                    <para>Optional step: To use an external service deployer for JBoss Cache,
                        create the cache service file
                        <filename>99_JBossCacheJNDI42-service.xml</filename>
                        in
                        <filename>${jboss.home}/server/default/deploy/</filename>
                        or simply copy it from the &flexive; source tree, if available:

                        <programlisting language="xml">
                            <xi:include href="../../src/framework/resources/jboss/99_JBossCacheJNDI42-service.xml"
                                        parse="text"/>
                        </programlisting>
                    </para>
                    <para>
                        If you want to use the external cache deplyoment you have to apply another modification:
                        Due to classloading issues (&flexive; uses JBoss Cache 2.x, while
                        JBoss 4.2 uses JBoss Cache 1.x) you need to modify the deployment scanner in
                        <filename>${jboss.home}/server/default/conf/jboss-service.xml</filename>:
                        replace the entry
                        <programlisting language="xml"><![CDATA[<attribute name="URLComparator">org.jboss.deployment.DeploymentSorter</attribute>]]></programlisting>
                        with
                        <programlisting language="xml"><![CDATA[<attribute name="URLComparator">org.jboss.deployment.scanner.AlphaNumericDeploymentSorter</attribute>]]></programlisting>
                        This ensures that the cache service is started after flexive.ear is deployed and thus
                        can use its cache implementation classes (this deployment scanner allows to influence
                        the deployment order with a numeric prefix, otherwise it's the same as the default one).
                    </para>
                </listitem>
            </itemizedlist>
        </section>
    </section>

    <section xml:id="glassfish_installation">
        <title>&Flexive; installation guide for Glassfish V2
        </title>
        <section xml:id="glassfish_installation_required_libs">
            <title>Required libraries</title>
            <para>Flexive needs several libraries to be deployed to the application server's internal
                <filename>lib</filename>
                directories. Execute these steps once glassfish has been setup.
            </para>
            <section xml:id="glassfish_installation_required_libs_ant_task">
                <title>Running the ant task</title>
                <para>We provide an
                    <command>ant</command>
                    task for you which copies all libraries needed
                    to deploy &Flexive; on Glassfish V2 to the specified directory.
                </para>
                <itemizedlist>
                    <listitem>
                        <para>Change to the
                            <filename>flexive-dist</filename>
                            directory of your [fleXive] distribution and run
                            <command>ant glassfish.libs</command>.
                        </para>
                        <para>You will be prompted to specify your
                            <filename>${glassfish.home}/domains/domain1/lib/ext</filename>
                            directory.
                            The
                            <command>ant</command>
                            task will copy all required libraries to this directory.
                        </para>
                    </listitem>
                    <listitem>
                        <para>Copy the
                            <filename>jbosscache-core.jar</filename>
                            from the
                            <filename>extlib</filename>
                            directory of your &Flexive; binary distribution to
                            <filename>${glassfish.home}/lib</filename>
                        </para>
                    </listitem>
                </itemizedlist>
            </section>
        </section>
        <section xml:id="glassfish_installation_db_setup">
            <title>Database Setup</title>
            <para>To set up the databases, follow
                <link linkend="jboss_installation_db_setup">these instructions</link>.
            </para>
        </section>
        <section xml:id="glassfish_installation_setup">
            <title>Setting up and starting Glassfish
            </title>
            <para>
                <emphasis>Setting up Glassfish</emphasis>
            </para>
            <orderedlist>
                <listitem>
                    <para>Go to the target installation directory
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <command><![CDATA[java -Xmx256m -jar <<path-to-downloaded-jar>>]]></command>
                        extracts the installation JAR to
                        <filename>./glassfish</filename>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        <command>cd glassfish</command>
                    </para>
                </listitem>
                <listitem>
                    <para>On Unix:
                        <command>chmod -R +x lib/ant/bin</command>
                    </para>
                </listitem>
                <listitem>
                    <para>
                        Execute the
                        <filename>setup.xml</filename>
                        buildfile
                        <itemizedlist>
                            <listitem>
                                <para>Unix:
                                    <command>lib/ant/bin/ant -f setup.xml</command>
                                </para>
                            </listitem>
                            <listitem>
                                <para>Windows:
                                    <command>lib\ant\bin\ant -f setup.xml</command>
                                </para>
                            </listitem>
                        </itemizedlist>
                    </para>
                </listitem>
            </orderedlist>
            <para>
                <emphasis>Starting Glassfish</emphasis>
            </para>
            <orderedlist>
                <listitem>
                    <para>
                        <command>bin/asadmin start-domain domain1</command>
                        starts the Glassfish server
                    </para>
                </listitem>
                <listitem>Open the URL
                    <para>
                        <link xlink:href="http://localhost:4848/">http://localhost:4848/</link>
                        and login using default credentials
                        <command>admin/adminadmin</command>.
                    </para>
                </listitem>
            </orderedlist>
            <para>Additional information</para>
            <orderedlist>
                <listitem>
                    <para>To stop the Glassfish instance execute
                        <command>${glassfish.home}/bin/asadmin stop-domain domain1</command>
                    </para>
                </listitem>
                <listitem>
                    <para>Admin UI Port: 4848</para>
                </listitem>
                <listitem>
                    <para>HTTP Port: 8080</para>
                </listitem>
                <listitem>
                    <para>HTTPS Port: 8181</para>
                </listitem>
            </orderedlist>
        </section>
        <section xml:id="glassfish_installation_conn_pools">
            <title>Creating the Connection pools
            </title>
            <para>Three connection pools, two for the division (transactional and non-transactional)
                and one for the configuration database, have to be set up.
            </para>
            <para>
                For MySQL copy and paste the following data-source definitions to a file (e.g.
                <code>flexive-ds.xml</code>)
                and update your database connection settings:
            </para>
            <programlisting language="xml">
                <xi:include parse="text" href="../../src/framework/resources/glassfish/flexive-ds.xml"/>
            </programlisting>
            <para>
                Respectively apply these settings for H2:
            </para>
            <programlisting language="xml">
                <xi:include parse="text" href="../../src/framework/resources/glassfish/flexive-h2-ds.xml"/>
            </programlisting>
            <para>
                While Glassfish is running, execute
                <command>${glassfish.home}/bin/asadmin add-resources /path/to/flexive-ds.xml</command>
                to create the connection pools and JDBC resources for MySQL or
                <command>${glassfish.home}/bin/asadmin add-resources /path/to/flexive-h2-ds.xml</command>
                if you are using the H2 database.
                You have to pass the absolute path to your XML file, otherwise Glassfish looks
                in its own config directory.
            </para>
            <para>
                Should you need to edit or reset your datasources, you can do so in the
                Glassfish administration console under
                <menuchoice>
                    <guimenuitem>Resources</guimenuitem>
                    <guimenuitem>JDBC.</guimenuitem>
                </menuchoice>
            </para>
        </section>
        <section xml:id="glassfish_installation_deployment">
            <title>Deployment</title>
            <para>Change to the
                <filename>flexive-dist</filename>
                directory of your &Flexive; distribution and run
                <command>ant ear</command>. This will create the
                <filename>flexive.ear</filename>
                file inside the
                <filename>flexive-dist</filename>
                directory.
            </para>
            <para>
                <emphasis>Using the autodeploy directory:</emphasis>
                <orderedlist>
                    <listitem>
                        <para>Copy the
                            <filename>flexive.ear</filename>
                            to
                            <filename>${glassfish.home}/domains/domain1/autodeploy</filename>
                        </para>
                    </listitem>
                </orderedlist>
            </para>
            <para>
                <emphasis>Using the Admin UI:</emphasis>
                <orderedlist>
                    <listitem>
                        <para>In the Admin Console, go to
                            <menuchoice>
                                <guimenuitem>Applications</guimenuitem>
                                <guimenuitem>Enterprise Applications</guimenuitem>
                            </menuchoice>
                        </para>
                    </listitem>
                    <listitem>
                        <para>Click
                            <code>Deploy...</code>
                            and upload the
                            <filename>flexive.ear</filename>
                            file.
                        </para>
                    </listitem>
                    <listitem>
                        <para>Click
                            <code>OK</code>
                        </para>
                    </listitem>
                </orderedlist>
                To access the backend point your browser to
                <link xlink:href="http://localhost:8080/flexive/adm/">http://localhost:8080/flexive/adm/</link>
                Alternatively you can specify your server's IP address, which is supported by default, too.
                The default superuser's username and password for the Backend Administration are
                username: supervisor, password: supervisor.
            </para>
        </section>
    </section>

    <xi:include href="includes/installation_building_from_source.xml"/>

    <section xml:id="installation_troubleshooting">
        <title>Troubleshooting</title>
        <section xml:id="installation_troubleshooting_jboss_multiple">
            <title>Multiple JBoss installations</title>
            <para>If there are multiple JBoss installations running in your local network you need
                to assign a different partition UDP group to each cluster! This can be done by adding
                <code>-Djboss.partition.udpGroup=230.2.3.4</code>
                (or any other multicast address you choose thats available)
                to the start script/command shown in<link linkend="jboss_installation_starting_flexive">
                Starting &Flexive;</link>.
            </para>
        </section>
        <section xml:id="installation_troubleshooting_glassfish_IPv4">
            <title>JBossCache, Linux and IPv6</title>
            <para>In order to run JBossCache on Linux IPv4 needs to be defined as the preferred IP stack.
                In the Glassfish admin console, go to
                <menuchoice>
                    <guimenuitem>Application Server</guimenuitem>
                    <guimenuitem>JVM Settings</guimenuitem>
                    <guimenuitem>JVM Options</guimenuitem>
                </menuchoice>
                and add the following option:
                <itemizedlist>
                    <listitem>
                        <para>
                            <code>-Djava.net.preferIPv4Stack=true</code>
                        </para>
                    </listitem>
                </itemizedlist>
            </para>
        </section>
        <section xml:id="installation_troubleshooting_ant">
            <title>Apache ANT</title>
            <itemizedlist>
                <listitem>
                    <para>If an ant-task fails, make sure you have
                        <link xlink:href="http://ant.apache.org">Apache ANT 1.7</link>
                        installed.
                    </para>
                </listitem>
                <listitem>
                    <para>If you get the following warning:
                        <programlisting>Problem: failed to create task or type javacc when executing ant
                        </programlisting>
                        make sure you installed the ant-optional package.
                    </para>
                </listitem>
            </itemizedlist>
        </section>
    </section>

</chapter>
        